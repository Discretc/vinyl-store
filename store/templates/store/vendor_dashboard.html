{% extends 'store/base.html' %}

{% block title %}Vendor Dashboard - Vinyl Store{% endblock %}

{% block content %}
<h2 class="page-title">Vendor Dashboard</h2>

<!-- Quick Actions -->
<div style="margin-bottom: 2rem;">
    <a href="{% url 'vendor_orders' %}" class="btn btn-primary">ðŸ“¦ Manage Orders</a>
</div>

<!-- Info Cards -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; max-width: 100%;">
    <div class="container" style="margin: 0;">
        <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Store Information</h3>
        <p style="font-size: 1.1rem; margin-bottom: 0.5rem;"><strong>{{ store.storeName }}</strong></p>
        <p style="color: #666; font-size: 0.95rem; margin-bottom: 0.75rem;">{{ store.description }}</p>
        <p style="color: #999; font-size: 0.85rem;">Created: {{ store.createdTime|date:"M d, Y" }}</p>
    </div>

    <div class="container" style="margin: 0;">
        <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Statistics</h3>
        <p style="font-size: 1rem; margin-bottom: 0.5rem;"><strong>{{ total_products }}</strong> products</p>
        <p style="color: #000; font-weight: bold; font-size: 1.4rem; margin-top: 0.75rem;">Total Sales: ${{ total_sales|floatformat:2 }}</p>
    </div>
</div>

<!-- Add Product Section -->
<div class="container" style="margin-bottom: 2rem;">
    <h3>Add New Product</h3>
    <form id="add-product-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        {% csrf_token %}
        <div class="form-group">
            <label for="productName">Product Name:</label>
            <input type="text" id="productName" name="productName" required>
        </div>
        <div class="form-group">
            <label for="price">Price:</label>
            <input type="number" id="price" name="price" step="0.01" required>
        </div>
        <div class="form-group">
            <label for="stockQuantity">Stock Quantity:</label>
            <input type="number" id="stockQuantity" name="stockQuantity" required>
        </div>
        <div style="display: flex; align-items: flex-end;">
            <button type="submit" class="btn btn-primary btn-block">Add Product</button>
        </div>
    </form>
    <div class="form-group" style="margin-top: 1rem;">
        <label for="description">Description:</label>
        <textarea id="description" name="description" form="add-product-form" required></textarea>
    </div>
</div>

<!-- Products List -->
<div class="container">
    <h3>Your Products</h3>
    {% if products %}
        <table class="cart-table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                    <tr>
                        <td>
                            <a href="{% url 'product_detail' product.productID %}">{{ product.productName }}</a>
                        </td>
                        <td>${{ product.price|floatformat:2 }}</td>
                        <td>{{ product.stockQuantity }}</td>
                        <td>{{ product.createdTime|date:"M d, Y" }}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <a href="{% url 'edit_product' product.productID %}" class="btn btn-small btn-primary">Edit</a>
                                <button onclick="openImageUpload({{ product.productID }})" class="btn btn-small btn-secondary">Images</button>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center; color: #999;">No products yet. Add your first product above!</p>
    {% endif %}
</div>

<!-- Image Upload Modal -->
<div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="container" style="width: 90%; max-width: 400px;">
        <h3>Upload Product Image</h3>
        <form id="image-form" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="imageProductId" name="product_id">
            <div class="form-group">
                <label for="image">Image File:</label>
                <input type="file" id="image" name="image" accept="image/*" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="isPrimary" name="is_primary">
                    Set as primary image
                </label>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary btn-block">Upload</button>
                <button type="button" onclick="closeImageUpload()" class="btn btn-secondary btn-block">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function openImageUpload(productId) {
    document.getElementById('imageProductId').value = productId;
    document.getElementById('imageModal').style.display = 'flex';
}

function closeImageUpload() {
    document.getElementById('imageModal').style.display = 'none';
    document.getElementById('image-form').reset();
}

document.getElementById('add-product-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('{% url "add_product" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Product added successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
});

document.getElementById('image-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const productId = document.getElementById('imageProductId').value;
    const formData = new FormData(this);
    
    fetch(`/vendor/product/${productId}/upload-image/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Image uploaded successfully!');
            closeImageUpload();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
});
</script>
{% endblock %}
