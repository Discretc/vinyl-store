{% extends 'store/base.html' %}

{% block title %}Browse Products - Vinyl Store{% endblock %}

{% block content %}
<h2 class="page-title">Browse Vinyl Records</h2>

<!-- Search and Filter Section -->
<div class="container" style="margin-bottom: 2rem;">
    <form method="get" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
        <div class="form-group">
            <label for="search">Search:</label>
            <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="Product name or description">
        </div>
        <div class="form-group">
            <label for="store">Filter by Store:</label>
            <select id="store" name="store">
                <option value="">All Stores</option>
                {% for store in stores %}
                    <option value="{{ store.storeID }}">{{ store.storeName }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="price-range">Price Range:</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="number" name="min_price" placeholder="Min" step="0.01">
                <span>-</span>
                <input type="number" name="max_price" placeholder="Max" step="0.01">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Filter</button>
    </form>
</div>

<!-- Products Grid -->
{% if products %}
    <div class="product-grid">
        {% for product in products %}
            <div class="product-card">
                {% if product.media.all %}
                    {% with primary=product.media.filter|dictsort:"isPrimary" %}
                        {% if primary %}
                            <img src="{{ primary.0.mediaURL.url }}" alt="{{ product.productName }}" class="product-image">
                        {% endif %}
                    {% endwith %}
                {% else %}
                    <div style="width: 100%; height: 250px; background-color: var(--light-color); display: flex; align-items: center; justify-content: center; color: #999;">No image</div>
                {% endif %}
                <div class="product-info">
                    <h3 class="product-name">{{ product.productName }}</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">{{ product.storeID.storeName }}</p>
                    
                    {% with promo=product.promotions.all|first %}
                        {% if promo.is_active %}
                            <p class="product-price discounted">${{ product.price|floatformat:2 }}</p>
                            <p class="product-price">${{ product.price|add:promo.get_discount_amount|floatformat:2 }}
                                <span class="product-discount">-{{ promo.discountRate }}%</span>
                            </p>
                        {% else %}
                            <p class="product-price">${{ product.price|floatformat:2 }}</p>
                        {% endif %}
                    {% endwith %}

                    {% with review_count=product.reviews.count avg_rating=product.reviews.aggregate|dictsort:"rating__avg" %}
                        {% if review_count > 0 %}
                            <p class="product-rating">‚≠ê {{ avg_rating }} ({{ review_count }} reviews)</p>
                        {% endif %}
                    {% endwith %}

                    <p class="product-stock {% if product.stockQuantity == 0 %}out{% elif product.stockQuantity < 5 %}low{% endif %}">
                        {% if product.stockQuantity > 0 %}
                            {{ product.stockQuantity }} in stock
                        {% else %}
                            Out of stock
                        {% endif %}
                    </p>
                    <div class="product-actions">
                        <a href="{% url 'product_detail' product.productID %}" class="btn btn-primary btn-small">View Details</a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üìÄ</div>
        <div class="empty-state-message">No products found</div>
        <p>Try adjusting your filters or search terms</p>
    </div>
{% endif %}
{% endblock %}
