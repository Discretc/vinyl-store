{% extends 'store/base.html' %}

{% block title %}Edit Product - Vinyl Store{% endblock %}

{% block content %}
<a href="{% url 'vendor_dashboard' %}" style="color: var(--accent-color);">‚Üê Back to Dashboard</a>

<div class="container" style="max-width: 800px; margin-top: 2rem;">
    <h2 class="page-title">Edit Product</h2>
    
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            <label for="productName">Product Name:</label>
            <input type="text" id="productName" name="productName" value="{{ product.productName }}" required>
        </div>
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" required>{{ product.description }}</textarea>
        </div>
        <div class="form-group">
            <label for="price">Price:</label>
            <input type="number" id="price" name="price" value="{{ product.price }}" step="0.01" required>
        </div>
        <div class="form-group">
            <label for="stockQuantity">Stock Quantity:</label>
            <input type="number" id="stockQuantity" name="stockQuantity" value="{{ product.stockQuantity }}" required>
        </div>
        <button type="submit" class="form-submit btn-primary">Save Changes</button>
    </form>

    <!-- Product Images Section -->
    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid var(--border-color);">
        <h3>Product Images</h3>
        
        <!-- Upload New Image Form -->
        <div style="background-color: var(--light-color); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">Upload New Image</h4>
            <form id="upload-image-form" enctype="multipart/form-data" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; align-items: end;">
                {% csrf_token %}
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="image">Image File:</label>
                    <input type="file" id="image" name="image" accept="image/*" required>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; text-transform: none; font-size: 0.9rem;">
                        <input type="checkbox" id="is_primary" name="is_primary">
                        Set as primary
                    </label>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>

        <!-- Existing Images -->
        {% if media %}
            <h4>Existing Images</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                {% for img in media %}
                    <div style="border: 2px solid {% if img.isPrimary %}#4ade80{% else %}var(--border-color){% endif %}; border-radius: 8px; padding: 1rem; background: white;">
                        <img src="{{ img.mediaURL.url }}" alt="Product image" style="width: 100%; height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 0.75rem;">
                        {% if img.isPrimary %}
                            <span style="background: #4ade80; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: bold;">PRIMARY</span>
                        {% else %}
                            <button onclick="setPrimary({{ img.mediaID }})" class="btn btn-small btn-secondary" style="width: 100%; margin-bottom: 0.5rem;">Set as Primary</button>
                        {% endif %}
                        <button onclick="deleteImage({{ img.mediaID }})" class="btn btn-small" style="width: 100%; background: var(--error-color); color: white;">Delete</button>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="text-align: center; color: #999; padding: 2rem;">No images yet. Upload one above!</p>
        {% endif %}
    </div>

    <!-- Promotions Section -->
    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid var(--border-color);">
        <h3>Promotions & Discounts</h3>
        
        <!-- Add Promotion Form -->
        <div style="background-color: var(--light-color); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">Add New Promotion</h4>
            <form id="add-promotion-form" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                {% csrf_token %}
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="discount_rate">Discount %:</label>
                    <input type="number" id="discount_rate" name="discount_rate" min="1" max="100" step="0.01" placeholder="e.g., 20" required>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="start_date">Start Date:</label>
                    <input type="datetime-local" id="start_date" name="start_date" required>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="end_date">End Date:</label>
                    <input type="datetime-local" id="end_date" name="end_date" required>
                </div>
                <button type="submit" class="btn btn-primary" style="grid-column: 1 / -1; padding: 1rem; white-space: nowrap;">Add Promotion</button>
            </form>
        </div>

        <!-- Existing Promotions -->
        <div id="promotions-list">
            {% if promotions %}
                <h4>Existing Promotions</h4>
                {% for promo in promotions %}
                    <div class="promotion-item" data-promo-id="{{ promo.promotionID }}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 1rem; padding: 1rem; background-color: var(--light-color); border-radius: 8px; margin-bottom: 0.75rem; align-items: center;">
                        <div>
                            <strong style="color: var(--accent-color); font-size: 1.2rem;">{{ promo.discountRate }}% OFF</strong>
                        </div>
                        <div>
                            <span style="color: #666; font-size: 0.85rem;">Start:</span>
                            <div style="font-size: 0.9rem;">{{ promo.startDate|date:"M d, Y H:i" }}</div>
                        </div>
                        <div>
                            <span style="color: #666; font-size: 0.85rem;">End:</span>
                            <div style="font-size: 0.9rem;">{{ promo.endDate|date:"M d, Y H:i" }}</div>
                        </div>
                        <div>
                            <span class="status-badge" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; background-color: {% if promo.status == 'active' %}var(--success-color){% elif promo.status == 'expired' %}var(--error-color){% else %}var(--warning-color){% endif %}; color: white;">
                                {{ promo.status|title }}
                            </span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            {% if promo.status != 'expired' %}
                                <button onclick="togglePromoStatus({{ promo.promotionID }})" class="btn btn-small btn-secondary">
                                    {% if promo.status == 'active' %}Deactivate{% else %}Activate{% endif %}
                                </button>
                            {% endif %}
                            <button onclick="deletePromotion({{ promo.promotionID }})" class="btn btn-small" style="background-color: var(--error-color); color: white;">Delete</button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: #999; padding: 2rem;">No promotions yet. Add one above to attract customers!</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Upload Image
document.getElementById('upload-image-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('{% url "upload_product_image" product.productID %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Image uploaded successfully!');
            location.reload();
        } else {
            alert(data.error || 'Error uploading image');
        }
    })
    .catch(error => {
        alert('Error uploading image');
        console.error(error);
    });
});

// Set Primary Image
function setPrimary(mediaId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/vendor/image/${mediaId}/set-primary/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Primary image updated!');
            location.reload();
        } else {
            alert(data.error || 'Error setting primary image');
        }
    })
    .catch(error => {
        alert('Error setting primary image');
        console.error(error);
    });
}

// Delete Image
function deleteImage(mediaId) {
    if (!confirm('Are you sure you want to delete this image?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/vendor/image/${mediaId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Image deleted successfully!');
            location.reload();
        } else {
            alert(data.error || 'Error deleting image');
        }
    })
    .catch(error => {
        alert('Error deleting image');
        console.error(error);
    });
}

// Add Promotion
document.getElementById('add-promotion-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('{% url "add_promotion" product.productID %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Promotion added successfully!');
            location.reload();
        } else {
            alert(data.error || 'Error adding promotion');
        }
    })
    .catch(error => {
        alert('Error adding promotion');
        console.error(error);
    });
});

// Delete Promotion
function deletePromotion(promotionId) {
    if (!confirm('Are you sure you want to delete this promotion?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/vendor/promotion/${promotionId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Promotion deleted successfully!');
            location.reload();
        } else {
            alert(data.error || 'Error deleting promotion');
        }
    })
    .catch(error => {
        alert('Error deleting promotion');
        console.error(error);
    });
}

// Toggle Promotion Status
function togglePromoStatus(promotionId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/vendor/promotion/${promotionId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'Error updating promotion status');
        }
    })
    .catch(error => {
        alert('Error updating promotion status');
        console.error(error);
    });
}
</script>
{% endblock %}
